# @configure_input@
include ../include/config.Makefile
VPATH = @srcdir@
DEPENDS = yes
finalprefix=@FINALPREFIX@
prefixtail=$(shell echo $(finalprefix) | sed 's=^/==')
prefixdir=$(shell dirname $(finalprefix))
############################## main targets
all install :: ../$(PKG_DEB) tidy
#################################
# notice that fakeroot is required, get it here: http://ftp.debian.org/debian/pool/main/f/fakeroot
../$(PKG_DEB) : debian-binary control.tar.gz data.tar.gz
	rm -f $@
	fakeroot chown root.root $^
	fakeroot ar rc $@.tmp $^
	sed -e 's=debian-binary/=debian-binary =' -e 's=control.tar.gz/=control.tar.gz =' -e 's=data.tar.gz/=data.tar.gz =' < $@.tmp > $@
	rm $@.tmp
CONTROLFILES := control
CONTROLFILES += md5sums
# CONTROLFILES += preinst
CONTROLFILES += postinst
CONTROLFILES += prerm
# CONTROLFILES += postrm
control.tar.gz : $(CONTROLFILES) control
	chmod a+x,g-w $(CONTROLFILES)
	fakeroot chown root $(CONTROLFILES) control
	fakeroot tar cfz $@ $^
prepare : ../$(PKG_TZ)
	rm -rf $(package) $(prefixtail)
	$(MKDIR_P) $(prefixtail)
	tar xfp $^ $(TAR_COMPRESS_OPTION)
	for i in $(package)/* ; do if [ -f "$$i" ] ; then rm "$$i" ; fi ; done
	mv $(package)/* $(prefixtail)
	rmdir $(package)
	chmod -R og-w,a+r $(prefixtail)
	find $(prefixtail) -name .linkdir | xargs rm -f
	find $(prefixtail) -name \*.info | while read x ; do gzip --best "$$x" ; done
	find $(prefixtail) -name \*.1 | while read x ; do gzip --best "$$x" ; done
	fakeroot chown -R root $(prefixtail)
data.tar.gz : prepare
	fakeroot tar cfz $@ $(prefixtail)
md5sums : prepare
	(cd $(prefixtail) && find * -type f | xargs md5sum) >$@
check-with-lintian : ../$(PKG_DEB)
	lintian -c ../$(PKG_DEB)
tidy :
	rm -rf $(prefixtail) control.tar.gz data.tar.gz md5sums
clean ::
	rm -rf $(package) $(prefixtail) debian-binary control.tar.gz data.tar.gz md5sums 
	rm -rf ../$(PKG_DEB)
distclean : clean; rm -f Makefile control

Makefile : Makefile.in; cd ..; ./config.status debian/Makefile
control.prelim : control.prelim.in
	cd ..; ./config.status debian/control.prelim
	chmod 0755 $@
control : control.prelim prepare
	(cat $< && echo Installed-Size: `du -s $(prefixtail) | sed 's/^\([0-9][0-9]*\).*/\1/'`) >$@
prerm : prerm.in
	cd ..; ./config.status debian/prerm
	chmod 0755 $@
preinst : preinst.in
	cd ..; ./config.status debian/preinst
	chmod 0755 $@
postrm : postrm.in
	cd ..; ./config.status debian/postrm
	chmod 0755 $@
postinst : postinst.in
	cd ..; ./config.status debian/postinst
	chmod 0755 $@

# Local Variables:
# compile-command: "make -C $M2BUILDDIR/debian "
# End:
