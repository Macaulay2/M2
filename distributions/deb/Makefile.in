# @configure_input@
include ../../include/config.Makefile
# ignore @datarootdir@
VPATH = @srcdir@
TIDY = yes
CHOWN = chown
prefixtail=$(shell echo @prefix@ | sed 's,^/,,')
TAROPTIONS = --owner=0 --group=0 --mode=a+rX,og-ws
.PHONY : prepare
############################## main targets

ifeq (@ARCH@,x86_64)
DEBARCH=amd64
else
DEBARCH=@ARCH@
endif

PKG_DEB = @PACKAGE_TARNAME@-@PACKAGE_VERSION@-$(DEBARCH)-@OS@-@ISSUE@.deb
PKG_COM_DEB = @PACKAGE_TARNAME@-@PACKAGE_VERSION@-common.deb

all: chk-opts macaulay2/control.prelim tidy_before ../../$(PKG_DEB) ../../$(PKG_COM_DEB) announce maybe-tidy
chk-opts:; [ "${prefix}" = /usr -a @DEBUG@ = no -a @OPTIMIZE@ = yes -a @STRIP@ = yes ]
macaulay2/control.prelim : @srcdir@/macaulay2/control.prelim.in Makefile
	rm -f $@
	<$< >$@ sed -e 's/[@]DEBARCH[@]/$(DEBARCH)/g' -e 's/[@]PACKAGE_VERSION[@]/@PACKAGE_VERSION@/g'
	! egrep -nH '@[A-Za-z_]+@' <$@
announce:
	@ echo "============================================================================="
	@ echo "package files prepared:"
	@ echo "        $(PKG_DEB)"
	@ echo "        $(PKG_COM_DEB)"
	@ echo "============================================================================="
ifeq ($(TIDY),yes)
maybe-tidy: tidy_after
else
maybe-tidy: tidy_after
endif
#################################
../../$(PKG_DEB) : @srcdir@/macaulay2/debian-binary macaulay2/control.tar.gz macaulay2/data.tar.gz
	rm -f $@
	ar rc $@.tmp $^
	sed -e 's=\(debian-binary\|control.tar.gz\|data.tar.gz\)/\( *[0-9]* *\)[0-9 ]\{12\}=\1 \20     0     =g' <$@.tmp >$@
	rm $@.tmp
../../$(PKG_COM_DEB) : @srcdir@/macaulay2-common/debian-binary macaulay2-common/control.tar.gz macaulay2-common/data.tar.gz
	rm -f $@
	ar rc $@.tmp $^
	sed -e 's=\(debian-binary\|control.tar.gz\|data.tar.gz\)/\( *[0-9]* *\)[0-9 ]\{12\}=\1 \20     0     =g' <$@.tmp >$@
	rm $@.tmp

macaulay2/control.tar.gz : macaulay2/control macaulay2/postinst macaulay2/prerm
	cd macaulay2 && chmod 0644 control
	cd macaulay2 && chmod 0755 postinst prerm
	tar cfz $@ $(TAROPTIONS) -C macaulay2 control postinst prerm

macaulay2-common/control.tar.gz : macaulay2-common/control macaulay2-common/postinst macaulay2-common/prerm
	cd macaulay2-common && chmod 0644 control
	cd macaulay2-common && chmod 0755 postinst prerm
	tar cfz $@ $(TAROPTIONS) -C macaulay2-common control postinst prerm

T=tar --create --mode=a+rX,og-ws --exclude-from=@srcdir@/../tar-exclusions --file=-
prepare : .prepared
.prepared : 
	rm -rf tmp@prefix@ tmp-common@prefix@
	$(MKDIR_P) tmp@prefix@
	$(MKDIR_P) tmp-common@prefix@
	$(T) -C @pre_exec_prefix@ . | tar xfp - -C tmp@prefix@
	$(T) -C @pre_prefix@      . | tar xfp - -C tmp-common@prefix@
	if [ -d tmp-common@prefix@/info ] ; \
	then $(MKDIR_P) tmp-common@prefix@/share/info && mv tmp-common@prefix@/info/* tmp-common@prefix@/share/info && rmdir tmp-common@prefix@/info; \
	fi
	if [ -d tmp-common@prefix@/man ] ; \
	then $(MKDIR_P) tmp-common@prefix@/share/man && mv tmp-common@prefix@/man/* tmp-common@prefix@/share/man && rmdir tmp-common@prefix@/man; \
	fi
	$(MKDIR_P) tmp@prefix@/share/doc/macaulay2
	$(MKDIR_P) tmp-common@prefix@/share/doc/macaulay2-common
	cp tmp-common@docdir@/README tmp@prefix@/share/doc/macaulay2/copyright
	cp tmp-common@docdir@/README tmp-common@prefix@/share/doc/macaulay2-common/copyright
	gzip -9 <@srcdir@/macaulay2/changelog >tmp@prefix@/share/doc/macaulay2/changelog.gz
	gzip -9 <@srcdir@/macaulay2-common/changelog >tmp-common@prefix@/share/doc/macaulay2-common/changelog.gz
	find tmp-common -name \*.info | while read x ; do gzip --best "$$x" ; done
	find tmp tmp-common -name man -type d | while read x ; do find $$x -type f -not -name \*.gz | while read y ; do gzip --best "$$y" ; done ; done
	find tmp -name \*.so -o -name \*.so.\* -o -name \*.la | xargs chmod a-x Makefile
	find tmp tmp-common -depth -mindepth 1 -type d -empty -delete
	touch $@
macaulay2/data.tar.gz        : prepare; (cd tmp        && tar cfz - $(TAROPTIONS) *) >$@
macaulay2-common/data.tar.gz : prepare;	(cd tmp-common && tar cfz - $(TAROPTIONS) *) >$@
macaulay2/md5sums            : prepare; (cd tmp        && find * -type f | xargs md5sum) >$@
macaulay2-common/md5sums     : prepare;	(cd tmp-common && find * -type f | xargs md5sum) >$@
ifneq (@LINTIAN@,)
SUP = fgrep -v 
check :
	- @LINTIAN@ -I ../../$(PKG_DEB)
	- @LINTIAN@ -I ../../$(PKG_COM_DEB)
else
check :
	@echo "install 'lintian' for checking *.deb packages"
endif
tidy_before :
	rm -rf .prepared tmp tmp-common
	rm -rf macaulay2/control.tar.gz macaulay2/data.tar.gz macaulay2/md5sums
	rm -rf macaulay2-common/control.tar.gz macaulay2-common/data.tar.gz macaulay2-common/md5sums
tidy tidy_after :
	rm -rf .prepared tmp tmp-common
	rm -rf macaulay2/control.tar.gz macaulay2/data.tar.gz macaulay2/md5sums
	rm -rf macaulay2-common/control.tar.gz macaulay2-common/data.tar.gz macaulay2-common/md5sums
clean :: tidy
	rm -rf ../../$(PKG_DEB) ../../$(PKG_COM_DEB)
distclean : clean; rm -f Makefile control
libraries-used : .prepared always
	ldd tmp@bindir@/M2@EXE@ | sed -e 's/.* => //' -e 's/^	//' -e 's/ .*//' | egrep '^/' >$@ || true
clean ::; rm -f libraries-used
packages-used : libraries-used
	cat libraries-used | while read x ; do find /var/lib/dpkg/info -name \*.list | xargs egrep -l "^$$x"; done | sort | uniq | sed -e 's=.*/==' -e 's=\.list$$==' >$@
clean ::; rm -f packages-used
macaulay2/control : macaulay2/control.prelim macaulay2/data.tar.gz packages-used
	(cat $< && \
	 size=`gunzip<macaulay2/data.tar.gz|wc -c` && \
	 size=`echo $$size | sed 's/^\([0-9][0-9]*\).*/\1/'` && \
	 echo Installed-Size: $$size && \
	 echo -n "Depends: macaulay2-common (= @PACKAGE_VERSION@)" && \
	 cat packages-used | while read x ; do echo -n ", $$x" ; done && \
	 echo \
	) >$@
clean ::; rm -f macaulay2/control
macaulay2-common/control : macaulay2-common/control.prelim macaulay2-common/data.tar.gz
	(cat $< && \
	 size=`gunzip<macaulay2-common/data.tar.gz|wc -c` && \
	 size=`echo $$size | sed 's/^\([0-9][0-9]*\).*/\1/'` && \
	 echo Installed-Size: $$size \
	) >$@
clean::; rm -f macaulay2/control.prelim
% : %.in; cd ../..; ./config.status distributions/deb/$@

# Local Variables:
# compile-command: "make -C $M2BUILDDIR/distributions/deb "
# End:
