# @configure_input@
include ../../include/config.Makefile
VPATH = @srcdir@
srcdir = $(shell cd @srcdir@; pwd)
DOC=cache/doc
TEST=cache/tests

.PHONY : all test-D-modules doc check initialize clean distclean install

all :: initialize

Makefile : Makefile.in
	cd ../..; ./config.status Macaulay2/packages/Makefile

#############################################################################
all :: doc
distclean :: clean
DOCFILES := StateTable.m2 eliminate.m2 D-modules/DMODdoc.m2
## DOCFILES += $(wildcard @srcdir@/D-modules/DOC/*.m2)

phase2: $(DOCFILES)
	@ set -v; for i in $^ ; do ../../bin/M2 -q '-e phase=2' $$i '-e exit 0' || exit 1; done
	touch "$@"

phase3: $(DOC) $(TEST)
	$(MAKE) -C $(DOC) -f $(srcdir)/../m2/Makefile.egs srcdir=$(srcdir)
	touch "$@"

phase4: $(DOCFILES)
	@ set -v; for i in $^ ; do ../../bin/M2 -q '-e phase=4; errorDepth 0' $$i '-e exit 0' || exit 1; done
	touch "$@"

TARGETDIR = cache/doc
phase5 : $(TARGETDIR)/index.html
$(TARGETDIR)/index.html : ../cache/Macaulay2-made ../cache/Macaulay2-doc ../libexec/Macaulay2
	 #------ phase 5: making html documentation
	../../bin/M2 -q -silent '-e makeHTML("D-modules Package", Documentation)' '-e exit 0'

HOMEDIR := $(shell cd .. && pwd)
phase6 :
	@ echo "make: Entering directory \`$(shell cd $(TARGETDIR) && pwd)'"
	 #------ phase 6: checking the links in the html documentation
	@ set -v && cd $(TARGETDIR) && $(HOMEDIR)/html-check-links/html-check-links *.html
	@ echo "make: Leaving directory \`$(shell cd $(TARGETDIR) && pwd)'"

doc : phase2 phase3 phase4 phase5 phase6

clean::; rm -f phase2
check:: doc
	$(MAKE) -C $(TEST) -f $(srcdir)/../m2/Makefile.tests srcdir=$(srcdir)
#############################################################################
Dtests = $(wildcard D-modules/TST/*.tst.m2)
Dtestresults = $(Dtests:.m2=.okay)
check:: test-D-modules
test-D-modules : $(Dtestresults)
$(Dtestresults) : ../libexec/Macaulay2 ../cache/Macaulay2-doc ../cache/Macaulay2-made
%.okay : %.m2
	@ echo running test file $<
	../../bin/M2 -q '-e path = prepend( "D-modules/", path )' '-e input "$<"' '-e exit 0'
	touch $@
#############################################################################
clean check distclean ::
	$(MAKE) -C ComputationsBook $@
#############################################################################
initialize :: cache $(DOC) $(TEST)
clean ::; rm -rf cache
cache $(DOC) $(TEST) :; mkdir -p $@

$(packagedir)/packages :; $(INSTALL) -d "$@"
install :: $(packagedir)/packages
	$(INSTALL_DATA) @srcdir@/*.m2 $<
	tar cf - -C @srcdir@ D-modules ComputationsBook | tar xf - -C $<

distclean ::; rm -f Makefile
