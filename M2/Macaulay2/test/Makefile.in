TOPDIR = ../..
include $(TOPDIR)/config.Makefile
VPATH = @srcdir@
INSTALL = @INSTALL@
INSTALL_PROGRAM = $(INSTALL)
INSTALL_DATA = $(INSTALL)

RESULTS := $(patsubst %.m2, %.okay, $(wildcard *.m2)) 
ifneq "$(DUMPDATA)" "no"
RESULTS := $(RESULTS) dumpdata.okay
endif

all :: $(RESULTS)

$(RESULTS) : ../libexec/Macaulay2 ../cache/Macaulay2-doc ../cache/Macaulay2-made

ifneq "$(DUMPDATA)" "no"
dumpdata.okay : dumpdata.1 dumpdata.2 dumpdata.3
	@ echo testing dumpdata
	@ ../libexec/Macaulay2 -q \
		   '-eloaddata("../libexec/Macaulay2-$(ARCH)-data")' \
		-- '-epath=append(path,"../m2")' '-erunStartFunctions()' \
		   '-eerrorDepth(0)' \
		   -silent @srcdir@/dumpdata.1 \
		   '-eexit(0)'
	@ echo exit 0 \
	  | ../libexec/Macaulay2 -q \
		   '-eloaddata("../libexec/Macaulay2-$(ARCH)-data")' \
		-- '-epath=append(path,"../m2")' \
		   '-erunStartFunctions()' '-eerrorDepth(0)' \
		   -silent @srcdir@/dumpdata.2 \
		-- @srcdir@/dumpdata.3
	@ touch dumpdata.okay
endif

ifneq "$(DUMPDATA)" "no"
ARGS := -q '-eloaddata("../$(DUMPDATAFILE)")' -- '-epath=append(path,"../m2")' '-erunStartFunctions()' '-eerrorDepth(0)' -silent
else
ARGS := -q -ephase=1 ../m2/setup.m2 -ephase=0 '-erunStartFunctions()' '-eerrorDepth(0)' -silent
endif

%.okay : %.m2
	@ echo testing $<
	@ ulimit -t 600; time ../libexec/Macaulay2 $(ARGS) $< '-eexit(0)'
	@ touch $@

clean  :	
	rm -f *.okay allfiles

distclean: clean
	rm -f Makefile

allfiles : *.m2 Makefile COPYRIGHT dumpdata.1 dumpdata.2 dumpdata.3
	echo $^ |tr ' ' \\012 >allfiles

docStructure.out : docStructure.m2
