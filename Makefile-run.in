#############################################################################

# Targets to use:
#	all:	make a binary distribution
#	justM2:	make Macalay2/libexec/Macaulay2 and Macaulay2/bin/M2, and set up
#               for running it
#	doc:	make the documentation
#	port:   make a porting source distribution
#	testport: test the porting source distribution in tmp/Macaulay2
# The default is 'all' and 'doc'.

#############################################################################
TOPDIR = .
include $(TOPDIR)/config.Makefile
srcdir = @srcdir@
top_srcdir = @top_srcdir@
VPATH = $(srcdir)
INSTALL = @INSTALL@
INSTALL_PROGRAM = $(INSTALL)
INSTALL_DATA = $(INSTALL)
#############################################################################
.PHONY : all always dirs clean announce MACAULAY2 MACAULAY2.doc doc port default
################################# default
default: all # doc
################################# all
all::
#################################
FILES := Makefile README patches
SUBDIRS := gc gmp factory libfac Macaulay2
export PATH := bin:$(PATH)
################################# preparation
all:: announce
announce::; @echo 'making Macaulay 2 version $(VERSION) for ARCH=$(ARCH) OS=$(OS) REL=$(REL)'
always:
all:: lib/.exists
lib/.exists:; mkdir lib; touch $@
clean::; rm -rf lib
clean::; rm -f core
distclean::; rm -f config.cache Makefile-configure.overrides config.log config.status configure
distclean:: clean
################################ SETUP
ifeq "$(CC)" "cl"
justM2 all:: ;	$(MAKE) -C WindowsNT
TARGET := Macaulay2-$(DESC).zip
DOCTARGET := Macaulay2-$(VERSION)-doc.zip
else
TARGET := distributions/Macaulay2-$(DESC).tar.gz
DOCTARGET := distributions/Macaulay2-$(VERSION)-doc.tar.gz
endif
justM2 all:: announce
announce ::
	@echo '## making $(TARGET)'
doc:: announce.doc
announce.doc ::
	@echo '## making $(DOCTARGET)'

###################### Macaulay 2 binary distribution
all :: MACAULAY2
all :: $(TARGET)
MACAULAY2:; $(MAKE) -C Macaulay2 all tests
justM2 distclean::; $(MAKE) -C Macaulay2 $@
DISTFILES := 	Macaulay2/README.txt \
		Macaulay2/CHANGES \
		Macaulay2/setup \
		Macaulay2/cache/Macaulay2-doc \
		Macaulay2/packages/*.m2 \
		Macaulay2/libexec/Macaulay2 \
		Macaulay2/m2/*.m2 \
		Macaulay2/m2/Makefile \
		Macaulay2/emacs \
		$(patsubst %.m2,%.out,$(wildcard Macaulay2/tutorial/final/*.m2))

ifeq "$(SHARED)" "yes"
DISTFILES += Macaulay2/lib
endif
distributions :; mkdir $@
clean ::; rm -rf distributions
distributions/Macaulay2-$(DESC).tar.gz : Makefile $(DISTFILES) distributions
	tar cf - $(DISTFILES) | gzip >"$@"
	@echo "-----------------------------------------------------------------------------"
	@echo "  $@ contains everything but the documentation"
	@echo "-----------------------------------------------------------------------------"
distributions/Macaulay2-$(DESC).zip : Makefile $(DISTFILES) distributions
	winzip32 -u -r -p $@ @WindowsNT/DistributionFiles.lst
	@echo "-----------------------------------------------------------------------------"
	@echo "  $@ contains everything but the documentation"
	@echo "-----------------------------------------------------------------------------"
install clean ::; $(MAKE) -C Macaulay2 $@
###################### Macaulay 2 porting source distribution
PORTING := CVS \
	Macaulay2/CVS \
	Macaulay2/basictests \
	Macaulay2/book \
	Macaulay2/c \
	Macaulay2/c2 \
	Macaulay2/d \
	Macaulay2/dbm \
	Macaulay2/dumpdata \
	Macaulay2/e/CVS \
	Macaulay2/e/misc \
	Macaulay2/emacs \
	Macaulay2/html \
	Macaulay2/m2 \
	Macaulay2/msdos \
	Macaulay2/packages \
	Macaulay2/test \
	Macaulay2/tutorial \
	Macaulay2/util \
	WindowsNT \
	bin factory gc gcStatic gmp libfac config include
portfilenames:
	Export3 $(PORTING)
port: distributions/Macaulay2-$(VERSION)-porting-src.tar.gz
distributions/Macaulay2-$(VERSION)-porting-src.tar.gz : Makefile distributions
	tar cf - `Export3 $(PORTING)` | gzip >$@
testport: testport-clean testport-files testport-go testport-clean
testport-clean:
	rm -rf tmp/M2
clean :: testport-clean
testport-files: distributions/Macaulay2-$(VERSION)-porting-src.tar.gz
	mkdir -p tmp/M2
	gunzip <$< |tar xf - -C tmp/M2
testport-go:
	@echo '## testing porting source'
	$(MAKE) -C tmp/M2
###################### Macaulay 2 documentation
DOCFILES = Macaulay2/html
DOCFILES += Macaulay2/Vasconcelos-appendix/appendix.dvi
# DOCFILES += Macaulay2/book/Macaulay2-$(VERSION)-book.dvi
# DOCFILES += Macaulay2/book/Macaulay2-$(VERSION)-book.pdf
# DOCFILES += Macaulay2/book/Macaulay2-$(VERSION)-book.ps

distributions/Macaulay2-$(VERSION)-doc.tar.gz : $(DOCFILES) distributions
	tar cf - $(DOCFILES) | gzip >$@
	@echo "-----------------------------------------------------------------------------"
	@echo "  $@ contains the documentation"
	@echo "-----------------------------------------------------------------------------"
distributions/Macaulay2-$(VERSION)-doc.zip : $(DOCFILES) distributions
	winzip32 -u -r -p $@ $(DOCFILES)
	@echo "-----------------------------------------------------------------------------"
	@echo "  $@ contains the documentation"
	@echo "-----------------------------------------------------------------------------"
MACAULAY2.doc:
	$(MAKE) -C Macaulay2 doc
# doc:: MACAULAY2
doc:: MACAULAY2.doc 
doc:: $(DOCTARGET)
################################# nondist
# print the files in the directory tree that are not part of the distribution
nondist :
	(Export; find . -name CVS -prune -o -type f -print ) | sort | uniq -u
################################# CVS
clean::
	find .  \( \
		   -type f -name '.#*' \
		-o -type d -name Release \
		-o -name '*.pdb' \
		\) |xargs rm -rf
	rm -f M2.ncb M2.opt
################################# final status messages
justM2 all doc::
	@echo "--------------------- done making '$@' --------------------"
################################# tar manufactured files
distributions/manufactured.tgz : Makefile
	make -C Macaulay2/d all-c-files
	make -C Macaulay2/tutorial
	tar cfz $@ \
		Macaulay2/e/geovec.hpp \
		Macaulay2/e/geores.hpp \
		Macaulay2/e/cmdnames.m2 \
		Macaulay2/e/cmdnames.hpp \
		Macaulay2/e/cmdinst.hpp \
		Macaulay2/m2/tutorials.m2 \
		Macaulay2/tutorial/final/*.out \
		Macaulay2/m2/gbdoc.m2 \
		Macaulay2/m2/gbfunctions.m2 \
		Macaulay2/m2/loads.m2 \
		Macaulay2/d/*.c \
		Macaulay2/m2/cache-tmp/Examples/*.m2 \
		Macaulay2/m2/cache-tmp/Tests/*.m2 \
		Macaulay2/html
################################# automated compilation
update:
	cvs update -d -P
	$(MAKE)
checkin:
	cvs ci -m "check-in from $(NODENAME) [$(ARCH) $(OS) $(REL)]"
################################# TAGS
TAGS: always
	etags `find . \( -name '*.h' -o -name '*.c' -o -name '*.s' \
		-o -name '*.S' \
		-o -name '*.d' \
		-o -name '*.in' -o -name '*.m2' \)`
clean::; rm -f TAGS
PATH:
	printenv $@
################################# lsm
lsm:
	sendmail lsm@execpc.com <Macaulay2.LSM

################################# configure
# make this one last
distclean ::; rm -f $(CONFIGURED_FILES) include/config.h include/config.h.in

# Local Variables:
# mode: Makefile
# End:
