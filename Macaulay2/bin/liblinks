#! /bin/sh

EXE="$1"
TARDIR="$2"

abspath () {
    test 0 != expr "$1" : "/"
}

readlinks () {
    x="$1"
    while y=$(readlink x)
    do if abspath "$y"
       then x="$y"
       else x=$(dirname "$x")/"$y"
       fi
    done
    echo "$x"
}

ldd "$EXE" | 
 egrep -v '^[[:space:]](linux-gate|/lib/ld-linux|libc|libm|libdl|libpthread)\.so' |
  (
  ret=
  while read x
  do nm=$(expr "$x" : "\(.*\) => ")
     if test "$nm"
     then fi=$(readlinks $(expr "$x" : ".* => \(.*\) ([0-9a-fx]*)$"))
	  ta="$TARDIR"/"$nm"
	  if test -h "$ta" && test $(readlink "$ta") = "$fi"
	  then ls -l "$ta"
	  elif test -e "$ta" -a ! -h "$ta"
	  then echo "error: file '$ta' is in the way" >&2
	       ls -l "$ta" >&2
	       ret=1
	  else ( test -h "$ta" && (set -x ; rm "$ta")
		 set -x; ln -s "$fi" "$ta" )
	  fi
     fi
  done
  exit $ret
  )

# Local Variables:
# compile-command: "make -C $M2BUILDDIR/Macaulay2/bin make-lib-links"
# End:

