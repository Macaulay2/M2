TOPDIR = ../..
include $(TOPDIR)/config.Makefile
srcdir = @srcdir@
top_srcdir = @top_srcdir@
VPATH = $(srcdir)
INSTALL = @INSTALL@
INSTALL_PROGRAM = $(INSTALL)
INSTALL_DATA = $(INSTALL)
include $(TOPDIR)/Makeconf

FILES := Makefile tutbook.m2 titlepage.tex \
	final/--INDEX final/*.m2 prelim/*.m2 translate.c
TUTORIALS := $(wildcard final/*.m2)
OUTPUTS := $(TUTORIALS:.m2=.out)

# Amazingly, under WINDOWS, whether the output from translate has nonzero length
# depends in an unpredictable way on the input file name.  So we check for that
# below and use the same input file name for all.
# Names that work: tempaaa.m2 aaa
# Names that don't work: tmpaaa.m2 temp.m2 fooobaaar
TMPIN := aaa
%.out : %.m2
	cp $*.m2 $(TMPIN)
	./translate <$(TMPIN) >$*.out
	[ -s $*.out ]
	rm $(TMPIN)

all:: final/cache/doc
final/cache/doc :; mkdir -p $@

all:: $(OUTPUTS)

tutbook.dvi : tutbook.tex ../book/macros.tex titlepage.tex
	tex $<
$(OUTPUTS) : translate
tutbook.tex : ../cache/Macaulay2-doc tutbook.m2 translate $(OUTPUTS)
	../bin/M2 '-e errorDepth 0' '-e writeExamples=true' tutbook.m2 '-e exit 0'
	$(MAKE) -k -C Examples -f ../../m2/Makefile.egs
	../bin/M2 -e'readExamples=true' tutbook.m2 '-e exit 0'

allfiles : Makefile prelim/*.m2 final/*.m2
	../bin/echoout $(FILES) >allfiles

clean :
	rm -rf *.dvi *.log allfiles translate final/*.out *.exe *.obj *.ilk *.pdb

