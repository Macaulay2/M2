# @configure_input@
include ../../include/config.Makefile
VPATH = @srcdir@

LD_LIBRARY_PATH := $(BUILTLIBPATH)/lib:$(LD_LIBRARY_PATH)
export LD_LIBRARY_PATH

PACKAGES = @PACKAGES@

RemakeAllDocumentation ?= false
IgnoreExampleErrors ?= false
CheckDocumentation ?= true
RerunExamples ?= false
debugLevel ?= 0

ARGS := RemakeAllDocumentation => $(RemakeAllDocumentation), \
	IgnoreExampleErrors => $(IgnoreExampleErrors), \
	RerunExamples => $(RerunExamples), \
	CheckDocumentation => $(CheckDocumentation), \
	UserMode => false, \
	InstallPrefix => \"@STAGINGAREA@/\", \
	SeparateExec => true

# so the user can override arguments to installPackage:
ifneq "$(IARGS)" ""
ARGS := $(ARGS), $(IARGS)
endif

check ::
	@ for i in $(PACKAGES) ; \
	  do ( \
	     set -x ; \
	     @pre_exec_prefix@/bin/M2@EXE@ -q --stop -e "needsPackage(\"$$i\",LoadDocumentation=>true); check($$i,UserMode=>false); exit 0" ; \
	     ) ; \
	  done

pre-install ::
	@ for i in $(PACKAGES) ; \
	  do ( \
	     set -x ; \
	     @pre_exec_prefix@/bin/M2@EXE@ \
		    $(M2DIRS) -q --stop -e errorDepth=0 -e debugLevel=$(debugLevel) $(EARGS) \
		    -e "installPackage(\"$$i\", $(ARGS)); exit 0" ; \
	     ) || exit 1 ; \
	done

prefix := @pre_prefix@
@packagesdir@/%.m2 : %.m2 ; @INSTALL_DATA@ $^ $@

clean::; rm -rf tmp *.installed

distclean::clean
clean check distclean ::; $(MAKE) -C ComputationsBook $@
Makefile: Makefile.in; cd ../..; ./config.status Macaulay2/packages/Makefile
distclean::; rm -f Makefile

## here is the list of other files to install along with Macaulay2
pre-install :: @packagesdir@/eliminate.m2 @packagesdir@/D-modules.m2
@packagesdir@/eliminate.m2 : eliminate.m2 ; cp $^ "$@"
@packagesdir@/D-modules.m2 : D-modules.m2 ; cp $^ "$@"

# this one we need for compatibility with the book
pre-install :: @packagesdir@/LLL.m2
@packagesdir@/LLL.m2 : LLL.m2 ; cp $^ "$@"

# Local Variables:
# compile-command: "make -C $M2BUILDDIR/Macaulay2/packages "
# End:

