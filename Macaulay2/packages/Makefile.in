TOPDIR = ../..
include $(TOPDIR)/config.Makefile
VPATH = @srcdir@
INSTALL = @INSTALL@
INSTALL_PROGRAM = $(INSTALL)
INSTALL_DATA = $(INSTALL)

DOC=cache/doc
TEST=cache/tests

.PHONY : all test-D-modules doc tests initialize clean distclean install

all :: initialize

Makefile : Makefile.in
	cd $(TOPDIR); config.status Macaulay2/packages/Makefile

#############################################################################
all :: doc
doc : $(DOC) $(TEST)
	../bin/M2 -q '-e phase=2' StateTable.m2 '-e exit 0'
	../bin/M2 -q '-e phase=2' eliminate.m2  '-e exit 0'
	$(MAKE) -k -C $(DOC) -f ../../@srcdir@/../m2/Makefile.egs
tests :: doc
	$(MAKE) -k -C $(TEST) -f ../../@srcdir@/../m2/Makefile.tests
#############################################################################
Dtests = $(wildcard D-modules/TST/*.tst.m2)
Dtestresults = $(Dtests:.m2=.okay)
tests :: test-D-modules
test-D-modules : $(Dtestresults)
$(Dtestresults) : ../libexec/Macaulay2 ../cache/Macaulay2-doc ../cache/Macaulay2-made
%.okay : %.m2
	@ echo running test file $<
	../bin/M2 -q '-e path = prepend( "D-modules/", path )' '-e input "$<"' '-e exit 0'
	touch $@
#############################################################################
tests ::
	$(MAKE) -C ComputationsBook tests
#############################################################################
initialize :: cache $(DOC) $(TEST)
clean :; rm -rf cache
cache $(DOC) $(TEST) :; mkdir -p $@

initialize :: $(DOC)/up.gif $(DOC)/next.gif $(DOC)/previous.gif $(DOC)/top.gif \
		$(DOC)/index.gif $(DOC)/null.gif 
$(DOC)/up.gif $(DOC)/next.gif $(DOC)/previous.gif $(DOC)/top.gif $(DOC)/index.gif $(DOC)/null.gif :
	ln -s ../../../html/$(shell basename $@) $(DOC)

install ::
	rm -rf $(datadir)/Macaulay2/packages
	$(INSTALL) -d $(datadir)/Macaulay2/packages $(datadir)/Macaulay2/packages/cache/doc
	$(INSTALL_DATA) *.m2 $(datadir)/Macaulay2/packages
	$(INSTALL_DATA) cache/doc/* $(datadir)/Macaulay2/packages/cache/doc

distclean : clean
	rm -f Makefile
