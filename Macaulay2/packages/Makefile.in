# @configure_input@
include ../../include/config.Makefile
VPATH = @srcdir@
srcdir = $(shell cd @srcdir@; pwd)
DOC=cache/doc
TEST=cache/tests

.PHONY : all test-D-modules doc check initialize clean distclean install

all :: initialize

#############################################################################
all :: doc
distclean :: clean
DOCFILES := eliminate.m2 D-modules/DMODdoc.m2

phase2: $(DOCFILES)
	@ set -x; for i in $^ ; do ../../bin/M2 -q -e 'phase=2' $$i -e 'exit 0' || exit 1; done
	touch "$@"


ifeq "$(DEBUG)" "yes"
EGFLAGS = -k
EGMORE = || true
endif

phase3: $(DOC) $(TEST)
	$(MAKE) $(EGFLAGS) -C $(DOC) -f $(srcdir)/../m2/Makefile.egs srcdir=$(srcdir) $(EGMORE)
	touch "$@"

phase4: $(DOCFILES)
	@ set -x; for i in $^ ; do ../bin/M2 -q -e 'phase=4; errorDepth = 0' $$i -e 'exit 0' || exit 1; done
	touch "$@"
TARGETDIR = cache/doc
phase5 : $(TARGETDIR)/index.html
$(TARGETDIR)/index.html : ../cache/Macaulay2-made ../cache/Macaulay2-doc ../bin/M2
	 #------ phase 5: making html documentation
	../bin/M2 -q --silent \
		-e 'phase = 5' \
		-e 'load "D-modules.m2"' \
		-e 'makeHTML("D-modules Package", Documentation)' -e 'exit 0'

HOMEDIR := $(shell cd .. && pwd)
phase6 :
	@ echo "make: Entering directory \`$(shell cd $(TARGETDIR) && pwd)'"
	 #------ phase 6: checking the links in the html documentation
	@ cd $(TARGETDIR) && $(HOMEDIR)/html-check-links/html-check-links *.html
	@ echo "make: Leaving directory \`$(shell cd $(TARGETDIR) && pwd)'"

doc : phase2 phase3 phase4 phase5 phase6
clean::; rm -f phase2 phase3 phase4 phase5 phase6
check:: doc
	$(MAKE) -C $(TEST) -f $(srcdir)/../m2/Makefile.tests srcdir=$(srcdir)
#############################################################################
Dtests = $(wildcard D-modules/TST/*.tst.m2)
Dtestresults = $(Dtests:.m2=.okay)
check:: test-D-modules
test-D-modules : $(Dtestresults)
$(Dtestresults) : ../bin/M2$(EXE) ../cache/Macaulay2-doc ../cache/Macaulay2-made
%.okay : %.m2
	@ echo running test file $<
	../bin/M2 -q -e 'path = prepend( "D-modules/", path )' -e 'input "$<"' -e 'exit 0'
	touch $@
################################# srcdir
initialize :: srcdir
srcdir :; ln -s "@srcdir@" srcdir
#############################################################################
clean check distclean ::
	$(MAKE) -C ComputationsBook $@
#############################################################################
initialize :: cache $(DOC) $(TEST)
clean ::; rm -rf cache
cache $(DOC) $(TEST) :; mkdir -p $@

packagedir =? UNASSIGNED

$(packagedir)/packages :
	$(INSTALL) -d "$@"
install :: $(packagedir)/packages
	$(INSTALL_DATA) @srcdir@/*.m2 $<
	tar cf - -C @srcdir@ D-modules ComputationsBook | tar xf - -C $<

################################# Makefile
Makefile : Makefile.in
	cd ../..; ./config.status Macaulay2/packages/Makefile
distclean::; rm -f Makefile
