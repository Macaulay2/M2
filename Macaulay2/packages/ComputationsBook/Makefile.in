TOPDIR = ../../..
include $(TOPDIR)/config.Makefile
srcdir = @srcdir@
VPATH = $(srcdir)
INSTALL = @INSTALL@
INSTALL_PROGRAM = $(INSTALL)
INSTALL_DATA = $(INSTALL)

CHAPTERS = completeIntersections \
	   constructions \
	   d-modules \
	   exterior-algebra \
	   geometry \
	   monomialIdeals \
	   preface \
	   programming \
	   schemes \
	   solving \
	   toricHilbertScheme \
	   varieties

Makefile : Makefile.in
	cd $(TOPDIR); config.status Macaulay2/packages/ComputationsBook/Makefile
distclean:; rm -f Makefile

check : $(CHAPTERS:=.test)

.PHONY: clean changes distclean all check run-1-test

%.test :
	mkdir -p $*
	$(MAKE) -C $* -f ../Makefile TOPDIR=../$(TOPDIR) srcdir=../@srcdir@/$* run-1-test

run-1-test: test.out.expected.trim test.out.trim
	diff -u $^

test.out.trim : test.out patterns ../patterns
	sed -f $(srcdir)/../patterns -f $(srcdir)/patterns <$< >$@

test.out.expected.trim : test.out.expected patterns ../patterns
	sed -f $(srcdir)/../patterns -f $(srcdir)/patterns <$< >$@

changes:
	-for i in $(CHAPTERS); \
	do diff -u @srcdir@/$$i/chapter.m2 @srcdir@/$$i/test.m2 ;\
	   diff -u @srcdir@/$$i/chapter.out.expected @srcdir@/$$i/test.out.expected ;\
	done

clean::
	rm -f */*.trim

test.out : test.m2 \
		../../../bin/M2 ../../../libexec/Macaulay2 \
		../../../cache/Macaulay2-doc ../../../cache/Macaulay2-made
	ulimit -v 320000 && \
	time nice -18 ../../../bin/M2 -x -s -q \
		"-e path = prepend(\"$(srcdir)/\",path)" \
		<$(srcdir)/test.m2 >test.out.tmp && \
	mv test.out.tmp test.out

clean::
	rm -f */*.out programming/foo

