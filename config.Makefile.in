
# every makefile that includes this one should use 'all' as the
# default (first) target
all::

# cygwin 'make' might get confused by setting SHELL
# SHELL = @SHELL@

VERSION = @VERSION@
ARCH    = @ARCH@
OS      = @OS@
REL     = @REL@
DESC    = @VERSION@-@ARCH@-@OS@-@REL@

DUMPDATA = @DUMPDATA@
SOCKS = @SOCKS@
NODENAME = @NODENAME@
SHARED = @SHARED@
FACTORY = @FACTORY@
FACTORYVERSION = @FACTORYVERSION@
PROFILE = @PROFILE@
STRIP = @STRIP@
OPTIMIZE = @OPTIMIZE@
DEBUG = @DEBUG@
MEMDEBUG = @MEMDEBUG@
VERBOSE = @VERBOSE@
STATIC = @STATIC@
GMP = @GMP@
GMPLIB = @GMPLIB@
GC_FOR_NEW = @GC_FOR_NEW@
GC = @GC@

CC = @CC@
CXX = @CXX@
YACC = @YACC@
AWK = @AWK@
CFLAGS = @CFLAGS@
CPPFLAGS = @CPPFLAGS@
CXXFLAGS = @CXXFLAGS@
FFLAGS = @FFLAGS@
DEFS = @DEFS@
LDFLAGS = @LDFLAGS@
LIBS = @LIBS@
prefix = @prefix@
exec_prefix = @exec_prefix@
program_transform_name = @program_transform_name@
bindir = @bindir@
sbindir = @sbindir@
libexecdir = @libexecdir@
datadir = @datadir@
sysconfdir = @sysconfdir@
sharedstatedir = @sharedstatedir@
localstatedir = @localstatedir@
libdir = @libdir@
includedir = @includedir@
oldincludedir = @oldincludedir@
infodir = @infodir@
mandir = @mandir@
RANLIB = @RANLIB@
AR = ar

MAKEFLAGS += -w

ifdef CYGWIN32
# CFLAGS += '-Dabort()=exit(1)'
# CXXFLAGS += '-Dabort()=exit(1)'
# this approach to fixing "abort" doesn't work because of a slight
# bug in configure/makeconf - strings here get evaluated by the
# shell a different number of times between now and
#   (1) the evaluation of the test compilations in factory/configure
#   (2) the evaluation of the compilations in factory/GNUmakefile
# and thus it is impossible to shield the parentheses from the shell.
# A fix is for all expressions in factory/configure like 
#	eval $ac_compile
# to be replaced by expressions like
#	eval `eval "echo $ac_compile"`
endif

ifeq "$(OS) $(ARCH)" "Linux alpha"
AS = gcc -c -x assembler-with-cpp
endif

ifeq "$(CC)" "cl"
include config.Microsoft
endif

DEBUGFLAGS :=

ifeq "$(DEBUG)" "yes"
DEBUGFLAGS += -g -DDEBUG
else
DEBUGFLAGS += -DNDEBUG
endif

ifeq "$(PROFILE)" "yes"
CFLAGS   += -pg
CXXFLAGS += -pg
LDFLAGS  += -pg
STRIP := no
endif

ifeq "$(OPTIMIZE)" "yes"
ifeq "$(CC)" "gcc"
CFLAGS   += -fexpensive-optimizations -O3
CXXFLAGS += -fexpensive-optimizations -O3
endif
endif

ifeq "$(STRIP)" "no"
STRIPCMD := :
else
ifneq "$(CC)" "cl"
# -fomit-frame-pointer causes strange bugs!
# CFLAGS   += -fomit-frame-pointer
# CXXFLAGS += -fomit-frame-pointer
LDFLAGS  += -s
STRIPCMD := strip
endif
endif

ifeq "$(MEMDEBUG)" "yes"
DEBUGFLAGS += -DMEM_DEBUG
endif

export M2HOME := $(shell cd $(TOPDIR)/Macaulay2; pwd)

ifeq "$(SHARED)" "yes"
ifdef LD_LIBRARY_PATH
export LD_LIBRARY_PATH:=$(M2HOME)/lib:$(LD_LIBRARY_PATH)
else
export LD_LIBRARY_PATH:=$(M2HOME)/lib
endif
endif

ifneq "$(DUMPDATA)" "no"
DUMPDATAFILE := libexec/Macaulay2-$(ARCH)-data
endif
